#!/usr/bin/env bash

set -euo pipefail

# make sure go is installed
if ! command -v go &> /dev/null; then
    echo "Go is not installed. Please install Go and try again."
    exit 1
fi

# make sure docker is installed
if ! command -v docker &> /dev/null; then
    echo "Docker is not installed. Please install Docker and try again."
    exit 1
fi

BINARY_NAME="container-use"

# Build the application
echo "Building $BINARY_NAME..."
go build -o "$BINARY_NAME" ./cmd/container-use

# Prefer $HOME/.local/bin
PREFERRED_DIR="$HOME/.local/bin"
mkdir -p "$PREFERRED_DIR"

if [[ ":$PATH:" == *":$PREFERRED_DIR:"* ]]; then
    DEST="$PREFERRED_DIR"
    echo "Using $DEST (in PATH)"
else
    echo "$PREFERRED_DIR is not in PATH, searching for writable directory in \$PATH..."

    # Fallback: find first writable dir in $PATH
    IFS=':' read -ra PATH_DIRS <<< "$PATH"
    DEST=""
    for dir in "${PATH_DIRS[@]}"; do
        if [ -w "$dir" ]; then
            DEST="$dir"
            echo "Using fallback writable directory: $DEST"
            break
        fi
    done

    if [ -z "$DEST" ]; then
        echo "Error: No writable directory found in \$PATH"
        exit 1
    fi
fi

# Move the binary
echo "Installing $BINARY_NAME to $DEST..."
mv "$BINARY_NAME" "$DEST/"

echo "$BINARY_NAME successfully installed to $DEST"
